---
import type { ImageMetadata } from 'astro'
import type { HTMLAttributes } from 'astro/types'
import { Image as AstroImage } from 'astro:assets'
import { getEntry } from 'astro:content'

interface Props extends HTMLAttributes<'img'> {
  size?: 'sm' | 'md' | 'lg' | undefined
  id?: any
  position?: 'background' | 'cover' | 'inset' | undefined
}

const { id } = Astro.props
const entry = id ? (await getEntry('images', id))?.data : {}

const {
  width = 1920,
  height = 1920,
  position,
  src,
  alt,
  size,
  ...rest
} = {
  ...entry,
  ...Astro.props,
}

function getAltBySrc() {
  if (!src) return
  const filename = src?.split('/').pop()
  const slug = filename && filename.split('.')[0]
  const unslugged = slug?.replace(/-/g, ' ')
  return unslugged || ''
}

const images = import.meta.glob<{ default: ImageMetadata }>('/src/images/*')
const image = images[src as keyof typeof images]
---

{
  image && (
    <AstroImage
      class:list={[
        'image',
        {
          [`size-${size}`]: size,
          [`position-${position}`]: position,
        },
      ]}
      alt={alt || getAltBySrc()}
      src={image ? image() : src}
      width={width}
      height={height}
      {...rest}
    />
  )
}

<style is:global>
  @layer fulldev {
    .image {
      display: block;
      width: 100%;
      height: auto;

      &.position-background {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        margin: 0 !important;
        border-radius: 0;
        width: 100%;
        max-width: none;
        height: 100%;
        max-height: 100%;
        object-fit: cover;
      }

      &.position-cover {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      &.position-inset {
        margin-top: calc(var(--inset-top) * -1);
        margin-right: calc(var(--inset-right) * -1);
        margin-bottom: calc(var(--inset-bottom) * -1);
        margin-left: calc(var(--inset-left) * -1);
        width: calc(100% + var(--inset-left) + var(--inset-right));
        max-width: none;
        height: calc(100% + var(--inset-top) + var(--inset-bottom));
        object-fit: cover;
      }
    }
  }
</style>
