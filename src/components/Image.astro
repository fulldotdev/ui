---
import type { ImageMetadata } from 'astro'
import type { HTMLAttributes } from 'astro/types'
import { Image as AstroImage } from 'astro:assets'
import { getEntry } from 'astro:content'

interface Props extends HTMLAttributes<'img'> {
  position?: 'background' | 'cover' | 'inset' | undefined
}

const { width = 1920, height = 1920, position, src, alt, ...rest } = Astro.props

function getAltBySrc() {
  if (!src) return
  const filename = src?.split('/').pop()
  const slug = filename && filename.split('.')[0]
  const unslugged = slug?.replace(/-/g, ' ')
  return unslugged || ''
}

const images = import.meta.glob<{ default: ImageMetadata }>('/src/images/*')
const localImage = src && images[`/src/images/${src}`]
const id = localImage && src.split('.').shift()
const entry = id && ((await getEntry('images', id)) as any)

const newAlt = alt ?? entry?.data.alt ?? getAltBySrc() ?? ''
const newSrc = localImage ? localImage() : src
---

{
  newSrc && (
    <AstroImage
      class:list={['image', position && `position-${position}`]}
      src={newSrc as typeof src}
      alt={newAlt as typeof alt}
      width={localImage ? undefined : width}
      height={localImage ? undefined : height}
      {...(rest as any)}
    />
  )
}

<style is:global lang="scss">
  @layer fulldev {
    .image {
      display: block;
      width: 100%;
      height: auto;

      &.position-background {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        margin: 0 !important;
        border-radius: 0;
        width: 100%;
        max-width: none;
        height: 100%;
        max-height: 100%;
        object-fit: cover;
      }

      &.position-cover {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      &.position-container {
        width: 100%;
        height: 100%;
        object-fit: contain;
        object-position: center;
      }

      &.position-inset {
        max-width: none;
        object-fit: cover;

        &:is(.structure-column > &) {
          margin-right: calc(var(--inset-right) * -1);
          margin-left: calc(var(--inset-left) * -1);
          width: calc(100% + var(--inset-left) + var(--inset-right));

          &.image:first-child {
            margin-top: calc(var(--inset-top) * -1);
            height: calc(100% + var(--inset-top) * 1);
          }

          &.image:last-child {
            margin-bottom: calc(var(--inset-bottom) * -1);
            height: calc(100% + var(--inset-bottom) * 1);
          }
        }

        &:is(.structure-split > &) {
          @media (max-width: 1023.999px) {
            margin-right: calc(var(--inset-right) * -1);
            margin-left: calc(var(--inset-left) * -1);
            width: calc(100% + var(--inset-left) + var(--inset-right));

            &.image:first-child {
              margin-top: calc(var(--inset-top) * -1);
              height: calc(100% + var(--inset-top) * 1);
            }

            &.image:last-child {
              margin-bottom: calc(var(--inset-bottom) * -1);
              height: calc(100% + var(--inset-bottom) * 1);
            }
          }

          @media (min-width: 1024px) {
            margin-top: calc(var(--inset-top) * -1);
            margin-bottom: calc(var(--inset-bottom) * -1);
            height: calc(100% + var(--inset-top) * 1 + var(--inset-bottom) * 1);

            &.image:first-child {
              margin-left: calc(var(--inset-left) * -1);
              width: calc(100% + var(--inset-left) * 1);
            }

            &.image:last-child {
              margin-right: calc(var(--inset-right) * -1);
              width: calc(100% + var(--inset-right) * 1);
            }
          }
        }
      }
    }
  }
</style>
