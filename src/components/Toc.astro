---
import type { HTMLAttributes } from 'astro/types'
import type { CollectionEntry } from 'astro:content'
import Button from 'fulldev-ui/components/Button.astro'
import Heading from 'fulldev-ui/components/Heading.astro'
import Root from 'fulldev-ui/components/Root.astro'

type Props = HTMLAttributes<'aside'> & {
  render?: CollectionEntry<'pages'>['render'] | undefined
  size?: 'sm' | 'md' | 'lg' | undefined
}

const { size = 'sm', render } = Astro.props

const headings = render ? (await render())?.headings : []
const h2Headings = headings?.filter((heading: any) => heading.depth === 2)
---

<input
  id="toc"
  class="toc-checkbox"
  type="checkbox"
/>

<Root
  class:list="toc"
  as="aside"
  {size}
>
  {
    headings?.length > 0 && (
      <>
        <Heading
          text="On this page"
          level={6}
        />
        <Button
          variant="link"
          href={`#${headings[0]?.slug}`}
          text="Overview"
        />
        {h2Headings.map((heading: any) => (
          <Button
            variant="link"
            href={`#${heading.slug}`}
            text={heading.text}
          />
        ))}
      </>
    )
  }
</Root>

<style lang="scss" is:global>
  @layer fulldev {
    .toc-checkbox {
      display: none;
    }

    @media (max-width: 1023.999px) {
      body:has(.toc-checkbox:checked) {
        overflow: hidden;
      }
    }

    .toc {
      --toc-width: 240px;

      display: none;
      position: fixed;
      top: var(--header-height, 0px);
      right: 0;
      flex-shrink: 0;
      flex-direction: column;
      justify-content: flex-start;
      gap: calc(var(--space-4) + var(--space-1));
      z-index: 10;
      border-left-width: 1px;
      border-style: solid;
      border-color: var(--color-a6);
      background-color: var(--color-background);
      padding: var(--space-md-6) var(--gutter);
      width: 100%;
      max-height: calc(100vh - var(--header-height, 0px));
      overflow-y: auto;

      &:is(.toc-checkbox:checked + &) {
        display: flex;
      }

      @media (min-width: 1024px) {
        display: flex;
        position: sticky;
        border-left-width: 1px;
        width: var(--toc-width);
      }

      .button + .heading {
        margin-top: var(--space-5);
      }
    }
  }
</style>
