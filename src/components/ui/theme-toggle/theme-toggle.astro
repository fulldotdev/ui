---
import { cn } from "@/lib/utils"
import { Button } from "@/components/ui/button"
import { Icon } from "@/components/ui/icon"

interface Props {
  class?: string
}

const { class: className } = Astro.props
---

{/* This is intentionally inlined to avoid FOUC. */}
<script is:inline>
  ;(function () {
    const getThemePreference = () => {
      if (
        typeof localStorage !== "undefined" &&
        localStorage.getItem("theme")
      ) {
        return localStorage.getItem("theme")
      }
      return window.matchMedia("(prefers-color-scheme: dark)").matches
        ? "dark"
        : "light"
    }
    const isDark = getThemePreference() === "dark"
    document.documentElement.classList[isDark ? "add" : "remove"]("dark")
    document.documentElement.setAttribute(
      "data-theme",
      isDark ? "dark" : "light"
    )

    if (typeof localStorage !== "undefined") {
      const observer = new MutationObserver(() => {
        const isDark = document.documentElement.classList.contains("dark")
        localStorage.setItem("theme", isDark ? "dark" : "light")
        document.documentElement.setAttribute(
          "data-theme",
          isDark ? "dark" : "light"
        )
      })
      observer.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ["class"],
      })
    }
  })()
</script>

<Button
  data-slot="theme-toggle"
  variant="ghost"
  size="icon-sm"
  aria-label="Toggle theme"
  class={cn("relative", className)}
>
  <Icon name="sun" class="dark:hidden [&:is([data-theme=dark]_&)]:hidden" />
  <Icon
    name="moon"
    class="hidden dark:block [&:is([data-theme=dark]_&)]:block"
  />
</Button>

<style>
  :global(html.no-transitions *) {
    @apply !transition-none !duration-0;
  }
</style>

<script>
  document.querySelectorAll("[data-slot='theme-toggle']").forEach((toggle) => {
    toggle.addEventListener("click", () => {
      console.log("toggle theme")
      const html = document.documentElement
      html.classList.add("no-transitions")
      html.classList.toggle("dark")

      const isDark = html.classList.contains("dark")
      html.setAttribute("data-theme", isDark ? "dark" : "light")

      requestAnimationFrame(() => {
        html.classList.remove("no-transitions")
      })
    })
  })
</script>
