---
import { getCollection, type CollectionEntry } from "astro:content"

import type { BlockSchema, PageSchema } from "@/lib/schemas"

type Props = BlockSchema & PageSchema

function getHref(entry: CollectionEntry<"pages">) {
  // If there is no content, return undefined
  if (!entry.data.sections?.length && !entry.body?.length && !entry.data.block)
    return undefined
  // If the page is the index, return the root
  if (entry.id === "index") return "/"
  // else return href b yid
  return `/${entry.id}/`
}

const pages = await getCollection("pages")

// Get a single reference by file path
async function getRef(value: string) {
  const entry = pages.find((page) => `/${page.filePath}` === value)
  if (!entry) return
  return {
    href: getHref(entry),
    ...entry.data,
  }
}

// Get multiple references by file paths
async function getRefs(values: string[]) {
  return (await Promise.all(values.map(getRef))).filter(
    (item) => item !== undefined
  )
}

// Get a glob of pages by folder path
async function getGlob(value: string) {
  return pages
    .filter((page) => page.filePath?.startsWith(`src/content/pages/${value}`))
    .map((page) => ({
      href: getHref(page),
      ...page.data,
    }))
}

const {
  block,
  itemRef,
  itemsRefs,
  itemsGlob,
  tileRef,
  tilesRefs,
  tilesGlob,
  ...props
} = Astro.props

// Populate references
itemRef && (props.item = await getRef(itemRef))
itemsRefs && (props.items = await getRefs(itemsRefs))
itemsGlob && (props.items = await getGlob(itemsGlob))
tileRef && (props.tile = await getRef(tileRef))
tilesRefs && (props.tiles = await getRefs(tilesRefs))
tilesGlob && (props.tiles = await getGlob(tilesGlob))

const blockImports = import.meta.glob("./blocks/**/*.astro")
const blockPath = `./blocks/${block}.astro`
const blockImport = (await blockImports[blockPath]?.()) as any
const BlockComponent = blockImport?.default as any
---

{
  BlockComponent && (
    <BlockComponent {...props}>
      <slot />
      {"html" in props && <Fragment set:html={props.html} />}
    </BlockComponent>
  )
}
