---
import type { ComponentProps, HTMLTag, Polymorphic } from 'astro/types'
import type { CollectionEntry } from 'astro:content'
import Badge from 'fulldev-ui/components/Badge.astro'
import Box from 'fulldev-ui/components/Box.astro'
import Button from 'fulldev-ui/components/Button.astro'
import Card from 'fulldev-ui/components/Card.astro'
import Column from 'fulldev-ui/components/Column.astro'
import Heading from 'fulldev-ui/components/Heading.astro'
import Image from 'fulldev-ui/components/Image.astro'
import List from 'fulldev-ui/components/List.astro'
import Rating from 'fulldev-ui/components/Rating.astro'
import Root from 'fulldev-ui/components/Root.astro'
import Text from 'fulldev-ui/components/Text.astro'
import Wrap from 'fulldev-ui/components/Wrap.astro'
import Tagline from './Tagline.astro'

type Props<As extends HTMLTag = 'section'> = Polymorphic<{ as: As }> & {
  position?: 'background' | 'cover' | 'inset' | undefined
  buttons?: ComponentProps<typeof Button<'a'>>[] | undefined
  button?: ComponentProps<typeof Button<'a'>> | undefined
  cards?: ComponentProps<typeof Card<'a'>>[] | undefined
  badge?: string | ComponentProps<typeof Badge<'a'>> | undefined
  image?: ComponentProps<typeof Image>['src'] | undefined
  rating?: number | undefined
  pages?: CollectionEntry<'pages'>['data'][] | undefined
  records?: CollectionEntry<'records'>['data'][] | undefined
  heading?: string | undefined
  title?: string | undefined
  text?: string | undefined
  html?: string | undefined
  description?: string | undefined
  label?: string | undefined
  tagline?: string | undefined
  list?: string[] | undefined
  theme?: 'light' | 'dark' | undefined
  color?: 'base' | 'brand' | undefined
  size?: 'sm' | 'md' | 'lg' | undefined
  frame?: 'none' | 'fill' | 'viewport' | 'panel' | undefined
  align?: 'start' | 'center' | 'end' | undefined
  justify?: 'start' | 'center' | 'end' | undefined
  structure?:
    | 'column'
    | 'split'
    | 'spread'
    | 'carousel'
    | 'grid'
    | 'masonry'
    | 'stack'
    | undefined
  level?: 1 | 2 | 3 | 4 | 5 | 6 | undefined
  space?: 'auto' | 'none' | undefined
  reverse?: 'odd' | 'even' | undefined
  variant?: 'primary' | 'secondary' | 'tertiary' | undefined
}

const {
  as = 'section',
  space = 'auto',
  frame = 'fill',
  structure = 'column',
  variant = 'secondary',
  align = 'start',
  level = 2,
  position,
  label,
  heading,
  badge,
  title,
  text,
  list,
  html,
  tagline,
  description,
  buttons,
  image,
  rating,
  size,
  button,
  cards,
  pages,
  records,
  justify,
  theme,
  ...rest
} = Astro.props

const mergedCards = (pages || records || cards)?.filter(Boolean)
const hasCards = mergedCards && mergedCards?.length > 0
const hasText = text || html || description || list
const hasButton = button || (buttons && buttons?.length > 0)

const buttonVariant = (i: number) => {
  if (variant === 'primary' && i === 0) return 'primary'
  else if (variant === 'primary' && i === 1) return 'secondary'
  else if (variant === 'primary' && i > 1) return 'tertiary'
  else if (variant === 'secondary' && i === 0) return 'secondary'
  else if (variant === 'secondary' && i > 0) return 'tertiary'
  else if (variant === 'tertiary') return 'tertiary'
  else return 'tertiary'
}
---

<Root
  class:list="section"
  justify={hasCards ? undefined : justify}
  theme={hasCards ? undefined : theme}
  structure={structure === 'split' ? 'split' : 'column'}
  frame={frame === 'panel' && hasCards ? 'fill' : frame}
  {as}
  {align}
  {space}
  {size}
  {...rest}
>
  <Box
    structure={structure === 'spread' ||
    structure === 'carousel' ||
    (!hasText && hasButton)
      ? 'spread'
      : 'column'}
    align={structure === 'split' ? 'start' : align}
  >
    <slot name="segment">
      <Column
        style={{ textWrap: 'balance' }}
        align={structure === 'split' || structure === 'spread'
          ? 'start'
          : align}
      >
        <slot name="writeup">
          <Rating
            color="brand"
            {align}
            {...typeof rating === 'number' ? { value: rating } : rating}
          />
          <Badge
            color="base"
            {...typeof badge === 'string' ? { html: badge } : badge}
          />
          <Tagline
            color="brand"
            html={tagline}
          />
          <Heading
            html={heading || title}
            {level}
          />
          <Text
            contrast={!hasCards && position === 'background' && true}
            html={html || text || description}
            lead={level === 1}
          />
          <List items={list} />
        </slot>
      </Column>
      <Wrap>
        <slot name="actions">
          {
            [button, ...(buttons ?? [])]
              .filter(Boolean)
              ?.map((button: any, i: number) => (
                <Button
                  variant={buttonVariant(i)}
                  {...button}
                />
              ))
          }
        </slot>
      </Wrap>
    </slot>
  </Box>
  <slot>
    <Box
      structure={structure === 'split' || structure === 'spread'
        ? 'column'
        : structure}
      position={structure === 'carousel' ? 'inset' : undefined}
      size={size === 'lg' ? 'md' : 'sm'}
    >
      <slot name="deck">
        {
          mergedCards?.map(({ ...rest }: any) => (
            <Card
              align="start"
              level={Number(level) + 2}
              {position}
              {frame}
              {justify}
              {theme}
              {variant}
              {...rest}
            />
          ))
        }
      </slot>
    </Box>
    <Image
      position={hasCards ? undefined : position}
      src={image}
    />
  </slot>
</Root>

<style is:global lang="scss">
  @layer fulldev {
    .section {
      --inset-x: var(--gutter);
      --inset-y: var(--spacer);

      position: relative;
      overflow: auto;

      &.frame-fill {
        padding: var(--inset-y) var(--inset-x);
      }

      &.frame-viewport {
        padding: var(--inset-y) var(--inset-x);
        min-height: 100vh;
      }

      &.frame-panel {
        --inset-x: min(var(--gutter), var(--spacer));

        margin: var(--spacer) var(--gutter);
        border: 1px solid var(--base-a6);
        border-radius: var(--radius-2);
        background-color: var(--color-2);
        padding: var(--inset-y) var(--inset-x);
        overflow: hidden;
      }

      @media (min-width: 1024px) {
        &:nth-of-type(odd).split.reverse-odd {
          > :first-child {
            order: 999;
          }

          > :last-child {
            order: 0;
          }
        }

        &:nth-of-type(even).split.reverse-even {
          > :first-child {
            order: 0;
          }

          > :last-child {
            order: 999;
          }
        }
      }
    }
  }
</style>
