---
import type { ComponentProps, HTMLAttributes, HTMLTag } from 'astro/types'
import Button from 'fulldev-ui/components/Button.astro'
import Buttons from 'fulldev-ui/components/Buttons.astro'
import type Card from 'fulldev-ui/components/Card.astro'
import Cards from 'fulldev-ui/components/Cards.astro'
import Element from 'fulldev-ui/components/Element.astro'
import Heading from 'fulldev-ui/components/Heading.astro'
import Image from 'fulldev-ui/components/Image.astro'
import Badge from './Badge.astro'
import Lead from './Lead.astro'
import List from './List.astro'
import Paragraph from './Paragraph.astro'
import Price from './Price.astro'
import Rating from './Rating.astro'
import Tagline from './Tagline.astro'

interface Props extends HTMLAttributes<'section'> {
  as?: HTMLTag
  size?: 'sm' | 'md' | 'lg' | undefined
  image?: ComponentProps<typeof Image>
  buttons?: ComponentProps<typeof Buttons>['buttons']
  button?: ComponentProps<typeof Button> | undefined
  variant?: ComponentProps<typeof Button>['variant']
  cards?: ComponentProps<typeof Cards>['cards']
  panel?: ComponentProps<typeof Card>['panel']
  component?: string
  heading?: any
  background?: any
  lead?: any
  rating?: any
  tagline?: any
  badge?: any
  level?: any
  paragraph?: any
  dark?: boolean
  list?: any
  price?: any
  center?: boolean
  inset?: boolean
  reverse?: boolean
  frame?: 'fill' | 'panel' | 'viewport' | undefined
  position?: 'contain' | 'inset' | 'background' | undefined
  structure?:
    | 'left'
    | 'center'
    | 'spread'
    | 'split'
    | 'grid'
    | 'masonry'
    | 'carousel'
    | 'stack'
    | undefined
}

const { component, ...props } = Astro.props

const {
  as = 'section',
  size = 'md',
  variant = 'secondary',
  structure = 'left',
  inset = false,
  panel = false,
  reverse = false,
  dark = false,
  frame = 'viewport',
  position = 'background',
  level = 2,
  rating,
  tagline,
  badge,
  heading,
  lead,
  paragraph,
  list,
  price,
  buttons,
  image,
  background,
  cards,
  ...rest
} = props

const allComponents = {
  ...import.meta.glob('/src/**/*.astro'),
  ...import.meta.glob('../../**/*.astro'),
}

const componentPath = Object.keys(allComponents).find(
  (path) => path.split('/').pop()?.split('.')[0] === component
)

const Component =
  componentPath && (await (allComponents[componentPath] as any)()).default

const hasCards = cards && cards.length > 0
---

{
  Component ? (
    <Component {...props} />
  ) : (
    <Element
      class:list="section"
      panel={hasCards ? undefined : panel}
      {as}
      {size}
      {structure}
      {inset}
      {reverse}
      {dark}
      {position}
      {frame}
      {...rest}
    >
      <Element class:list="section-container">
        <Element class:list="section-segment">
          <Element class:list="section-content">
            <Rating
              {size}
              {...rating}
            />
            <Tagline
              text={tagline}
              {size}
            />
            <Badge
              {size}
              {...badge}
            />
            <Heading
              text={heading}
              {size}
              {level}
            />
            <Lead
              text={lead}
              {size}
            />
            <Paragraph
              text={paragraph}
              {size}
            />
            <List
              items={list}
              {size}
            />
            <Price
              value={price}
              {size}
            />
            <slot name="content" />
          </Element>
          <Buttons
            {size}
            {variant}
            {buttons}
          />
          <slot name="segment" />
        </Element>
        <Image {...image} />
        <Cards
          {size}
          {level}
          {cards}
        />
        <slot />
      </Element>
    </Element>
  )
}

<style is:global>
  @layer fulldev {
    .section {
      @apply relative flex w-full items-center pb-28 pt-14 first:pt-0;

      .section-container {
        @apply container z-10 w-full;
      }

      .section-segment {
        @apply z-10 gap-8 py-16;
      }

      .section-content {
        @apply max-w-screen-md gap-6;
      }

      &.frame-fill {
        @apply pb-28 pt-14 first:pt-0;
      }

      &.frame-viewport {
        @apply min-h-screen pb-28 pt-14;

        .section-container {
          @apply justify-center;
        }
      }

      &.frame-panel {
        @apply px-gutter first:pt-gutter;

        .section-container {
          @apply relative overflow-hidden rounded-lg border bg-card;
        }
      }

      &.position-contain {
        .image {
          @apply h-auto w-full object-contain;
        }
      }

      &.position-background {
        .image {
          @apply absolute inset-0 h-full max-h-none w-full max-w-none object-cover opacity-30;
        }
      }

      &.position-inset {
        .section-container {
          @apply px-0;
        }

        .section-segment {
          @apply px-gutter;
        }

        .image {
          @apply h-auto w-full object-cover;
        }
      }

      &.dark {
        @apply bg-background;
      }

      &.structure-left {
        .section-container,
        .section-segment,
        .section-content {
          @apply flex flex-col items-start;
        }
      }

      &.structure-center {
        .section-container,
        .section-segment,
        .section-content {
          @apply flex flex-col items-center text-center;
        }
      }

      &.structure-split {
        .section-container {
          @apply grid auto-cols-fr gap-x-14 lg:grid-flow-col lg:items-center;
        }

        .section-segment,
        .section-content {
          @apply flex flex-col items-start;
        }
      }

      &.structure-spread {
        .section-container {
          @apply flex flex-col;
        }

        .section-segment {
          @apply flex w-full flex-row flex-wrap items-end justify-between;
        }
      }

      &.reverse {
        &:not(.structure-split) {
          .section-segment {
            @apply order-last;
          }
        }

        @media (min-width: 1024px) {
          .section-segment {
            @apply order-last;
          }
        }
      }
    }
  }
</style>
