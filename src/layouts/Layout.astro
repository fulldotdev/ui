---
import type { ComponentProps, HTMLAttributes } from 'astro/types'
import type { CollectionEntry } from 'astro:content'
import Article from 'fulldev-ui/blocks/Article.astro'
import Banner from 'fulldev-ui/blocks/Banner.astro'
import Footer from 'fulldev-ui/blocks/Footer.astro'
import Element from 'fulldev-ui/components/Element.astro'
import Head from 'fulldev-ui/components/Head.astro'
import Header from 'fulldev-ui/components/Header.astro'
import Sections from 'fulldev-ui/components/sections.astro'
import Sidebar from 'fulldev-ui/components/Sidebar.astro'
import Toc from 'fulldev-ui/components/Toc.astro'
import type { GlobalProps } from 'fulldev-ui/types/global-props'

type Props = GlobalProps &
  HTMLAttributes<'html'> & {
    render: CollectionEntry<'pages'>['render']
    slug: CollectionEntry<'pages'>['slug']
    header?: ComponentProps<typeof Header>
    footer?: ComponentProps<typeof Footer>
    sections?: ComponentProps<typeof Sections>['sections']
    banner?: any
    toc?: any
    sidebar?: any
    navigation?: any
    themeselect?: any
    code?: {
      head?: string
      body?: string
    }
    title?: string
    description?: string
    image?: string
    seo?: {
      title?: string
      description?: string
      image?: string
    }
  }

const {
  render,
  header,
  navigation,
  footer,
  sidebar,
  toc,
  sections,
  theme,
  banner,
  code,
  themeselect,
  ...rest
} = Astro.props
---

<!doctype html>
<html {...rest}>
  <Head {...Astro.props} />
  <Element
    as="body"
    {theme}
  >
    <slot name="banner">
      <Banner text={banner} />
    </slot>
    <slot name="header">
      <Header
        class:list={{
          'for-sidebar': sidebar,
        }}
        if={navigation || header}
        {...navigation}
        {...header}
      />
    </slot>
    <div class="core">
      <slot name="sidebar">
        <Sidebar
          if={sidebar}
          {...navigation}
          {...sidebar}
        />
      </slot>
      <main data-pagefind-body>
        <slot>
          <Article />
          <Sections {sections} />
        </slot>
      </main>
      <slot name="toc">
        <Toc
          heading={toc}
          {render}
        />
      </slot>
    </div>
    <slot name="footer">
      <Footer {...footer} />
    </slot>
    <Fragment set:html={code?.body} />

    <style lang="scss" is:global>
      @layer fulldev {
        html {
          width: 100%;
          min-height: 100vh;
          scroll-behavior: smooth;
          color-scheme: var(--color-scheme);
          font-size: var(--text-2);
          font-family: 'Inter', sans-serif;
        }

        body {
          --screen: 100vw;
          display: flex;
          flex-direction: column;
          background-color: var(--base-background);
          width: 100%;
          min-height: 100vh;
          color: var(--base-11);

          .for-sidebar {
            @media (min-width: 1024px) {
              display: none;

              ~ * {
                --header-height: 0px;
              }
            }
          }

          .core {
            display: flex;
            position: relative;
            flex-grow: 1;
            height: 100%;

            main {
              --screen: 1280px;
              display: flex;
              flex: 1;
              flex-direction: column;
              background-color: var(--color-background);
              width: 100%;
              max-width: 100vw;
              overflow-x: hidden;
            }
          }
        }
      }
    </style>
  </Element>
</html>

<script>
  const setTheme = (document: Document) => {
    const theme = localStorage.getItem('theme') || ''
    document.body.classList.add(`theme-${theme}`)
  }

  setTheme(document)

  document.addEventListener('astro:before-swap', (event) => {
    setTheme(event.newDocument)
  })
</script>
