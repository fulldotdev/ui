---
import { getCollection, render } from "astro:content"

import "@/styles/globals.css"

import { getEntry } from "astro:content"

import { getHrefByEntry } from "@/lib/collections"
import Layout from "@/components/misc/layout.astro"

export async function getStaticPaths() {
  const entries = await getCollection("content")
  return entries
    .map((entry) => {
      const href = getHrefByEntry(entry)
      if (!href) return undefined
      return {
        params: {
          entry: href === "/" ? undefined : href,
        },
        props: entry,
      }
    })
    .filter(Boolean)
}

const { Content } = await render(Astro.props)
const { id, data } = Astro.props

// Get the index layout, which applies to all pages
const indexLayout = await getEntry("layouts", "index")

// Get the layout for the current page
const folder = id.split("/").length > 1 ? id.split("/")[0] : undefined
const layout = data.layout || folder
const entryLayout = layout ? await getEntry("layouts", layout) : undefined

// // Merge the layouts with the entry
const merged = {
  ...indexLayout?.data,
  ...entryLayout?.data,
  ...data,
  blocks: [
    ...(data?.blocks ?? []),
    ...(entryLayout?.data.blocks ?? []),
    ...(indexLayout?.data.blocks ?? []),
  ],
}
---

<Layout {...merged}>
  <Content />
</Layout>
