---
import settings from "@/data/settings.json"
import { getCollection, getEntry, render } from "astro:content"

import { getHref } from "@/lib/get-href"
import { getSlug } from "@/lib/get-slug"
import Page from "@/components/misc/page.astro"

export async function getStaticPaths() {
  const pages = await getCollection("pages")
  return pages.map((page) => {
    return {
      params: {
        page: getSlug(page),
      },
      props: {
        page: page,
        search: pages.map((page) => ({
          text: page.data.title,
          href: getHref(page),
        })),
      },
    }
  })
}

const { page, search } = Astro.props
const { Content } = await render(page)

const { sections: sectionsOrRef, ...data } = page.data

const sections = sectionsOrRef
  ? await Promise.all(
      sectionsOrRef.map(async (section: any) => {
        if (section.collection && section.id) {
          const entry = await getEntry(section.collection, section.id)
          if (!entry) {
            throw new Error(`${section.collection}/${section.id} not found`)
          }
          return {
            id: section.id,
            ...entry.data,
          }
        }
        return section
      })
    )
  : undefined
---

<Page
  search={search}
  sections={sections}
  {...data}
  {...settings}
  pathname={page.filePath}
>
  <Content />
</Page>
