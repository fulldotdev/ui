---
import { getCollection, getEntry, render } from "astro:content"

import { getHref } from "@/lib/get-href"
import { transformImage } from "@/lib/transform-image"
import CmsEditor from "@/components/cms/cms-editor"
import CmsToolbar from "@/components/cms/cms-toolbar"
import Layout from "@/components/layout.astro"
import Page from "@/components/page.astro"

export async function getStaticPaths() {
  const pages = await getCollection("pages")
  return pages.map((page) => {
    const href = getHref(page)
    return {
      params: {
        page: href === "/" ? undefined : href,
      },
      props: page,
    }
  })
}

const { Content } = await render(Astro.props)
const page = Astro.props

const indexLayout = await getEntry("layouts", "index")
const typeLayout = page.data.type && (await getEntry("layouts", page.data.type))

const transformedPage = {
  ...page,
  data: {
    ...page.data,
    image: await transformImage(page.data.image),
  },
}
---

<Layout
  {...indexLayout?.data}
  {...typeLayout?.data}
  title={transformedPage.data.title}
  description={transformedPage.data.description}
  image={transformedPage.data.image}
>
  <CmsEditor client:load />
  <Page {...transformedPage.data}>
    <Content />
  </Page>
  <CmsToolbar client:load {...transformedPage} />
</Layout>
