---
import { Content1 } from "@/blocks/content-1"
import ShopifyLayout from "@/layouts/shopify-layout.astro"
import type { CollectionProps } from "@/schemas/blocks/collection"
import type { ContactProps } from "@/schemas/blocks/contact"
import type { HeroProps } from "@/schemas/blocks/hero"
import type { MediaProps } from "@/schemas/blocks/media"
import type { ProductProps } from "@/schemas/blocks/product"

import { getPage } from "@/lib/shopify"
import Block from "@/components/misc/block.astro"

export const prerender = false

const { shopifyPageHandle } = Astro.params

const page = await getPage(shopifyPageHandle || "index")
if (!page) return Astro.redirect("/404")

const { title, sections, seo, body } = page

const isIndex = shopifyPageHandle === undefined
const hasContent = page.body && page.body.trim().length > 0

const blockPropsMap = {
  hero: {
    variant: 3,
    align: "start",
  } satisfies HeroProps,
  products: {
    variant: 1,
    align: "start",
  } satisfies ProductProps,
  collections: {
    variant: 1,
    align: "start",
  } satisfies CollectionProps,
  media: {
    variant: 2,
    align: "center",
  } satisfies MediaProps,
  contact: {
    variant: 1,
    align: "start",
    form: {
      fields: [
        {
          type: "text",
          label: "Naam",
        },
        {
          type: "email",
          label: "Email",
          required: true,
        },
        {
          type: "tel",
          label: "Telefoon",
        },
        {
          type: "textarea",
          label: "Bericht",
        },
      ],
      submit: "Verstuur",
    },
  } satisfies ContactProps,
}
---

<ShopifyLayout title={title} {...seo}>
  {
    !isIndex && hasContent && (
      <Content1 level={1}>
        <Fragment set:html={body} />
      </Content1>
    )
  }
  {
    sections?.map((section, i) => (
      <>
        <Block
          level={(!hasContent || isIndex) && i === 0 ? 1 : 2}
          {...blockPropsMap[section.type as keyof typeof blockPropsMap]}
          {...section}
        />
      </>
    ))
  }
  {
    isIndex && hasContent && (
      <Content1 level={2}>
        <Fragment set:html={body} />
      </Content1>
    )
  }
</ShopifyLayout>
