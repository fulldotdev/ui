---
import { Font } from "astro:assets"
import { getEntry } from "astro:content"
import config from "fulldev:config"

import { Badge } from "@/components/ui/badge"
import ModeToggleProvider from "@/components/ui/mode-toggle/mode-toggle-provider.astro"
import { Section, SectionContent } from "@/components/ui/section"
import Block from "@/components/block.astro"
import Layout from "@/components/layout.astro"

const indexBlock = await getEntry("blocks", "index")

const allBlocks = import.meta.glob("src/components/blocks/**/*.astro", {
  eager: true,
})
const sortedBlocks = Object.entries(allBlocks).sort(([a], [b]) =>
  a.localeCompare(b, undefined, { numeric: true, sensitivity: "base" })
)

const indexLayout = await getEntry("layouts", "index")
---

<Layout
  {...config}
  {...indexLayout?.data.seo}
  title="Blocks - fulldev/ui"
  description="Browse all available block components"
>
  <Fragment slot="head">
    <ModeToggleProvider />
    <Font cssVariable="--font-base" preload />
    <Font cssVariable="--font-heading" preload />
    <Fragment set:html={indexLayout?.data.head} />
  </Fragment>
  <Block block={indexLayout?.data.header} />
  <Block block={indexLayout?.data.banner} />
  <main class="@container flex flex-col gap-6 px-4 py-8">
    {
      sortedBlocks.map(([path, block]: [string, any]) => {
        const id = path.split("/").pop()?.split(".")[0]
        const BlockComponent = block.default
        return BlockComponent ? (
          <Section class="flex flex-col gap-2">
            <SectionContent>
              {/* header */}
              <div class="flex flex-row items-center justify-between">
                <Badge variant="secondary" href={`/blocks/${id}/`}>
                  {id}
                </Badge>
              </div>
              {/* block */}
              <div id={id} class="relative overflow-hidden rounded-lg border">
                <div class="bg-background no-scrollbar @container relative aspect-video overflow-x-hidden">
                  <div class="@container h-full w-[1280px] origin-top-left scale-[calc(100cqw/1280px)]">
                    <BlockComponent {...indexBlock?.data}>
                      <Fragment set:html={indexBlock?.data?.html} />
                    </BlockComponent>
                  </div>
                </div>
              </div>
            </SectionContent>
          </Section>
        ) : null
      })
    }
  </main>
  <Block block={indexLayout?.data.footer} />
  <Fragment set:html={indexLayout?.data.body} />
</Layout>

<script>
  const searchInput = document.getElementById("search") as HTMLInputElement

  function filterBlocks(query: string) {
    const blocks = document.querySelectorAll(".block-preview")
    const searchQuery = query.toLowerCase()

    blocks.forEach((block) => {
      const blockId = (block as HTMLElement).id.toLowerCase()
      const isMatch = blockId.includes(searchQuery)
      ;(block as HTMLElement).style.display = isMatch ? "block" : "none"
    })
  }

  searchInput?.addEventListener("input", (e) => {
    const query = (e.target as HTMLInputElement).value
    filterBlocks(query)
  })

  filterBlocks("")
</script>
