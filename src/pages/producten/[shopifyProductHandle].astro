---
import { Product1 } from "@/blocks/product-1"
import ShopifyLayout from "@/layouts/shopify-layout.astro"
import type { Product } from "@shopify/hydrogen-react/storefront-api-types"

import { requestShopify } from "@/lib/shopify"

export const prerender = false

const { shopifyProductHandle } = Astro.params

const { product } = (await requestShopify(
  `#graphql
  query {
    product(handle: "${shopifyProductHandle}") {
      id
      title
      images(first: 50) {
        nodes {
          url
          altText
        }
      }
      descriptionHtml
      seo {
        title
        description
      }
      variants(first: 250) {
        nodes {
          id
          title
          price {
            amount
            currencyCode
          }
          compareAtPrice {
            amount
            currencyCode
          }
          selectedOptions {
            name
            value
          }
        }
      }
    }
  }
`
)) as { product: Product | null }

if (!product) return Astro.redirect("/404")
---

<ShopifyLayout
  title={product.seo?.title ?? undefined}
  description={product.seo?.description ?? undefined}
  image={{
    src: product.images.nodes[0]?.url,
    alt: product.images.nodes[0]?.altText ?? undefined,
  }}
>
  <Product1
    title={product.title}
    images={product.images.nodes.map((image) => ({
      src: image.url,
      alt: image.altText ?? undefined,
    }))}
    id={product.id}
    variants={product.variants.nodes}
  >
    <Fragment set:html={product.descriptionHtml} />
  </Product1>
</ShopifyLayout>
